!function(e){"use strict";var t=function(t,i){this.settings=e.extend({},this.defaults,t),this.setup()};t.prototype={constructor:t,settings:{},defaults:{debug:!1,runtimes:"html5,flash,silverlight,html4",max_size:"10mb",extensions:"jpg,png,zip,rar",multiple:!1,sortable:!0,download:!0,preview:!1,caption:!0,required:!1,drop_element:null,chunk_size:"1024kb",limit:1,url:"",download_url:"",preview_url:"",img_w:80,img_h:40},lang:{DOWNLOAD_BTN:"Download",LIMIT_REACHED:"Limit of files has been reached. Please first remove the files which you want to replace."},uploader:null,total:0,setup:function(){var t=this;this.uploader=new plupload.Uploader({runtimes:t.settings.runtimes,browse_button:t.settings.browse_button,container:t.settings.container,url:t.settings.url,flash_swf_url:t.settings.moxie_swf,silverlight_xap_url:t.settings.moxie_xap,drop_element:t.settings.browse_button,unique_names:!0,dragdrop:!0,chunk_size:t.settings.chunk_size,filters:{max_file_size:t.settings.max_size,mime_types:[{title:"Allowed files",extensions:t.settings.extensions}]},init:{PostInit:function(){e("#"+t.settings.file_list).html("");var i=e("#"+t.settings.id).val();if(""!=i)try{var n=JSON.parse(i);e(n).each(function(i,n){0==n.id&&(n.id=n.fullname.replace(/\./,"-")),t.pushFile(n),e("#"+n.id).find(".djcupload_in").append(e(t.prepareFileWrapper(n,!1,e("#"+n.id)))),e("#"+n.id).attr("data-filedata",JSON.stringify(n)),t.bindEvents(e("#"+n.id))})}catch(e){}},FilesAdded:function(e,i){if(t.total+i.length>t.settings.limit&&t.settings.limit>0){var n=t.settings.limit-t.total,s=i.length-n;if(s>0&&i.length>0)for(var a=i.length-1;a>=0;a--)s<=0?t.pushFile(i[a]):(e.removeFile(i[a]),s--);t.showError(t.lang.LIMIT_REACHED)}else plupload.each(i,function(e){t.pushFile(e)});this.start()},FileUploaded:function(e,i,n){t.completeFileContainer(i)},UploadProgress:function(e,i){t.updateFileContainer(i)},Error:function(e,i){var n=i.message;if(void 0!==i.response){var s=JSON.parse(i.response);void 0!==s.error&&void 0!==s.error.message&&(n=s.error.message)}void 0!==i.file&&t.removeUpFile(i.file);var a=n;t.showError(a)},UploadComplete:function(e,i,n){jQuery(document).trigger("djcplupload_"+t.settings.id,[e,i,n])}}}),this.settings.sortable&&e("#"+this.settings.file_list).sortable({axis:!1,cursor:"move",items:".djcupload_file",handle:".djcupload_in",cancel:"a,.btn,input",update:function(e,i){t.setValue()}}),this.uploader.init()},clearFiles:function(){e("#"+this.settings.file_list).html(""),e(window).trigger("djmsg:upload")},pushFile:function(t){var i=this;i.total++;var n=i.prepareFileContainer(t),s=e(n);s.find('[data-action="remove"]').click(function(t){t.preventDefault(),s.remove(),i.total--,i.setValue(),e(window).trigger("djmsg:uploadremove")}),e("#"+this.settings.file_list).append(s)},removeUpFile:function(t){e("#"+t.id).remove(),this.total--,this.setValue(),e(window).trigger("djmsg:uploadremove")},setValue:function(){var t=[],i=this;e("#"+this.settings.file_list).find(".djcupload_file").each(function(){var n=e(this),s=n.attr("data-filedata");s&&((s=JSON.parse(s)).caption=n.find('input[name="'+i.settings.id+'_file_caption[]"]').val(),t.push(s))});var n=JSON.stringify(t);"[]"==n&&(n=""),e("#"+this.settings.id).val(n)},prepareFileContainer:function(e){this.debug("file container prepare:",e);var t=this.settings.sortable?"djcupload_in sortable":"djcupload_in",i='<div id="'+e.id+'" class="djcupload_file"><div class="'+t+'">';return i+='<a href="#" data-action="remove" class="btn btn-mini">&times;</a> ',i+='<span class="djcupload_file_name">'+(e.name||e.fullname),i+=" ("+plupload.formatSize(e.size)+")",i+=" <b></b></span>",i+="</div></div>"},updateFileContainer:function(t){this.debug("file status updated:",t),e("#"+t.id).find("b").first().html("<span>"+t.percent+"%</span>")},completeFileContainer:function(t){this.debug("file upload completed:",t);var i={id:t.id,file_id:0,fullname:t.target_name,caption:t.name.replace(/\.[^.]+$/,""),url:this.settings.preview_url+t.target_name,size:t.size};e("#"+t.id).find(".djcupload_in").append(e(this.prepareFileWrapper(i,!0,e("#"+t.id)))),e("#"+t.id).attr("data-filedata",JSON.stringify(i)),this.bindEvents(e("#"+t.id)),this.setValue(),e(window).trigger("djmsg:upload")},prepareFileWrapper:function(t,i,n){var s='<input type="hidden" value="'+t.file_id+'" name="'+this.settings.id+'_file_id[]" />';return s+='<input type="hidden" value="'+t.fullname+'" name="'+this.settings.id+'_file_name[]" />',this.settings.caption?s+='<input type="text" value="'+t.caption+'" name="'+this.settings.id+'_file_caption[]" />':s+='<input type="hidden" value="'+t.caption+'" name="'+this.settings.id+'_file_caption[]" />',this.settings.preview&&n.find(".djcupload_in").css("background-image",'url("'+t.url+'")'),this.settings.download&&!i&&0!=t.file_id&&(void 0!==t.download_url?s+='<a class="djcupload_download" href="'+t.download_url+'" target="_blank">'+this.lang.DOWNLOAD_BTN+"</a>":s+='<a class="djcupload_download" href="'+this.settings.download_url+t.file_id+'" target="_blank">'+this.lang.DOWNLOAD_BTN+"</a>"),e(window).trigger("djmsg:upload"),s},bindEvents:function(e){var t=this;e.find('input[type="text"]').on("change",function(){t.setValue()})},showError:function(t){var i=e("<p />",{class:"djcupload_err_msg alert alert-error"}),n=e("<a />",{class:"close pull-right",href:"#",html:"&times;"});n.click(function(t){t.preventDefault(),e(this).parents(".djcupload_err_msg").remove()}),i.text(t),i.append(n),e("#"+this.settings.console).append(i)},debug:function(e,t){this.settings.debug&&(console.log(e),console.log(t))}},window.DJCPLUpload=t}(jQuery);