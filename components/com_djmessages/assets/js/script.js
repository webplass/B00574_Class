!function(t){"use strict";var e={state:{origin:"inbox",limit:20,start:0,pagesTotal:0,total:0,dir:"d",order:"date",url:"",search:"",ms:"",msid:0},xhr:null,formModal:null,init:function(e){var s=this;this.updateState(e),this.attachNavigation(),t('.djmsg-nav a[data-toggle="tab"]').on("show",function(e){var a=t(e.target).prop("hash").substring(5);window.history.replaceState(s.state,null,t(e.target).attr("href")),s.updateState({origin:a,start:0}),s.toggleLoader(!0),s.makeRequest()}),s.refresh()},attachNavigation:function(){var e=this,s=t("#msg-"+this.state.origin);s.find("form").submit(function(t){t.preventDefault(),e.makeRequest()}),s.find(".djmsg-search-input").keyup(function(t){13===t.keyCode&&s.find(".djmsg-search-btn").trigger("click")}),s.find(".djmsg-search-input").focus(function(){this.select()}),s.find(".djmsg-filter").change(function(s){var a={origin:e.state.origin};a[t(this).attr("name")]=t(this).val(),"ms"==t(this).attr("name")&&(a.msid=""),e.updateState(a),e.toggleLoader(!0),e.scrollTo(t("#djmsg-messages-wrapper")),e.makeRequest()}),s.find(".djmsg-search-btn").click(function(a){a.preventDefault(),e.updateState({origin:e.state.origin,search:s.find(".djmsg-search-input").val()}),e.toggleLoader(!0),e.scrollTo(t("#djmsg-messages-wrapper")),e.makeRequest()}),s.find(".pagination a.djmsg-pagination-link").click(function(s){var a=t(this).attr("data-start");""!==a&&(s.preventDefault(),window.history.replaceState(e.state,null,t(this).attr("href")),e.updateState({origin:e.state.origin,start:a}),e.toggleLoader(!0),e.scrollTo(t("#djmsg-messages-wrapper")),e.makeRequest())});var a=s.find("a.djmsg-sort-link");a.length>0&&a.click(function(s){var a=t(this).attr("data-sort");if(""!==a){s.preventDefault(),window.history.replaceState(e.state,null,t(this).attr("href"));var i=e.state.dir;a==e.state.order&&(i="d"==i?"a":"d"),e.updateState({origin:e.state.origin,order:a,dir:i}),e.toggleLoader(!0),e.scrollTo(t("#djmsg-messages-wrapper")),e.makeRequest()}});var i=t("#djmsg-list-limit");1==i.length&&i.change(function(){e.updateState({origin:e.state.origin,limit:t(this).val()}),e.toggleLoader(!0),e.scrollTo(t("#djmsg-messages-wrapper")),e.makeRequest()}),s.find(".msgs-toggle-all").change(function(){t(this).is(":checked")?(s.find('input[name="msg_id[]"]').attr("checked","checked"),s.find('input[name="msg_id[]"] + .toggle').addClass("checked")):(s.find('input[name="msg_id[]"]').removeAttr("checked"),s.find('input[name="msg_id[]"] + .toggle').removeClass("checked"))}),s.find("button.djmsgs-ui-btn").click(function(s){s.preventDefault();var a=t(this).attr("data-action");if(""==a)return!1;"refresh"==a?e.refresh():e.submitAction(a)}),s.find("button.djmsgs-ui-msg-btn").click(function(a){a.preventDefault();var i=t(this).attr("data-action"),r=t(this).attr("data-id");if(""==i||""==r)return!1;s.find('input[name="msg_id[]"]').each(function(){t(this).val()==r?t(this).attr("checked","checked"):t(this).removeAttr("checked")}),e.submitAction(i)}),s.find("a.djmsg-message-link").click(function(s){s.preventDefault(),s.stopPropagation();var a=t(this).attr("data-url"),i=t(this).attr("data-title");e.openMessage(a,i,t(this))})},updateState:function(t){this.state=Object.assign(this.state,t)},makeRequest:function(e){var s=this;this.xhr&&4!=this.xhr.readyState&&this.xhr.abort();var a=this.prepareData();void 0!==e&&""!=e&&(a+="&"+e),this.xhr=t.ajax({url:s.state.url,method:"get",data:a}).done(function(t){s.parseResonse(t),s.toggleLoader(!1)})},refresh:function(){this.toggleLoader(!0),this.makeRequest()},parseResonse:function(e){var s=t.parseJSON(e);this.updateState(s.state),t("#msg-"+this.state.origin).html(s.html),this.attachNavigation()},prepareData:function(){var t="origin="+this.state.origin;return t+="&start="+this.state.start,t+="&order="+this.state.order,t+="&dir="+this.state.dir,t+="&limit="+this.state.limit,t+="&search="+(null==this.state.search?"":this.state.search),t+="&ms="+(null==this.state.ms?"":this.state.ms),t+="&msid="+(this.state.msid<1?"":this.state.msid),t+="&format=raw"},submitAction:function(e){var s=this;this.xhr&&4!=this.xhr.readyState&&this.xhr.abort();var a=this.prepareData()+"&task=messages."+e,i=t("#msg-"+this.state.origin).find('input[name="msg_id[]"]:checked');i.length<1||(a+="&"+i.serialize(),this.xhr=t.ajax({url:s.state.url,method:"post",data:a}).done(function(t){s.parseActionResponse(t)}))},parseActionResponse:function(t){this.refresh()},openForm:function(e,s){var a=t("#djmsg-message-wrapper"),i=t("#djmsg-messages-wrapper"),r=a.find(".djmsg-frame-body");a.find(".djmsg-frame-title");r.find(".iframe").remove(),r.prepend('<iframe class="iframe" src="'+e+'" name="" height="300" width="100%" style="border: none"></iframe>'),i.hide(),a.show()},openMessage:function(e,s,a){var i=t(a).parents("tr");if(1==i.length){i.addClass("tr-opened"),this.toggleLoader(!0),t("#djmsg-messages-wrapper").find(".djmsg-quick-message-body").remove(),i.find(".djmsg-message-intro").hide();var r=t('<div class="djmsg-quick-message-body" />');i.find(".djmsg-message-body").append(r),r.prepend('<iframe class="iframe" src="'+e+'" name="" height="0" width="100%" style="border: none"></iframe>'),this.scrollTo(r)}},closeForm:function(){var e=t("#djmsg-message-wrapper");t("#djmsg-messages-wrapper").show(),e.hide()},closeMessage:function(){this.refresh()},pushMessage:function(t){alert(t)},toggleLoader:function(e){e?t("#djmsg-messages-wrapper").css("opacity",.3):t("#djmsg-messages-wrapper").css("opacity",1)},scrollTo:function(e){var s=t(e).offset().top-150;s<0&&(s=0),t("html, body").animate({scrollTop:s},200)}};window.DJMessagesUI=e}(jQuery);